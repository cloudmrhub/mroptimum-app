name: Build & Push Docker Images

on:
  push:
    branches:
      - main
      - mode1_mode2
    paths:
      - 'calculation/src/**'
      - 'calculation/Dockerfile*'
      - '.github/workflows/build-images.yml'
  
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  LAMBDA_REPO: mroptimum-lambda
  FARGATE_REPO: mroptimum-fargate

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "AWS Account: ${ACCOUNT_ID}"

      - name: Generate image metadata
        id: meta
        run: |
          IMAGE_TAG="${GITHUB_SHA::8}-$(date +%Y%m%d-%H%M%S)"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${IMAGE_TAG}"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker images
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
        run: |
          set -euo pipefail
          cd calculation/src

          LAMBDA_URI="${ECR_REGISTRY}/${LAMBDA_REPO}"
          FARGATE_URI="${ECR_REGISTRY}/${FARGATE_REPO}"

          echo "╔═══════════════════════════════════════════════════════════════╗"
          echo "║   Building Docker Images                                      ║"
          echo "╚═══════════════════════════════════════════════════════════════╝"
          echo "Lambda URI:  ${LAMBDA_URI}"
          echo "Fargate URI: ${FARGATE_URI}"
          echo "Image Tag:   ${IMAGE_TAG}"
          echo ""

          # Build Lambda image
          # CRITICAL: --provenance=false is required for AWS Lambda compatibility
          echo "Building Lambda image..."
          docker build --provenance=false -f DockerfileLambda -t ${LAMBDA_REPO}:${IMAGE_TAG} .
          docker tag ${LAMBDA_REPO}:${IMAGE_TAG} ${LAMBDA_URI}:${IMAGE_TAG}
          docker tag ${LAMBDA_REPO}:${IMAGE_TAG} ${LAMBDA_URI}:latest

          # Build Fargate image
          echo "Building Fargate image..."
          docker build --provenance=false -f DockerfileFargate -t ${FARGATE_REPO}:${IMAGE_TAG} .
          docker tag ${FARGATE_REPO}:${IMAGE_TAG} ${FARGATE_URI}:${IMAGE_TAG}
          docker tag ${FARGATE_REPO}:${IMAGE_TAG} ${FARGATE_URI}:latest

          # Push to ECR
          echo "Pushing Lambda images..."
          docker push ${LAMBDA_URI}:${IMAGE_TAG}
          docker push ${LAMBDA_URI}:latest

          echo "Pushing Fargate images..."
          docker push ${FARGATE_URI}:${IMAGE_TAG}
          docker push ${FARGATE_URI}:latest

          # Output URIs for next jobs
          echo "lambda_image_uri=${LAMBDA_URI}:latest" >> $GITHUB_OUTPUT
          echo "fargate_image_uri=${FARGATE_URI}:latest" >> $GITHUB_OUTPUT

          echo ""
          echo "✓ Images built and pushed successfully"
          echo "Lambda:  ${LAMBDA_URI}:latest"
          echo "Fargate: ${FARGATE_URI}:latest"

      - name: Print Build Summary
        run: |
          echo "╔═══════════════════════════════════════════════════════════════╗"
          echo "║   Build Complete                                              ║"
          echo "╚═══════════════════════════════════════════════════════════════╝"
          echo "✓ Docker images built and pushed to ECR"
          echo "  Lambda:  ${{ steps.build.outputs.lambda_image_uri }}"
          echo "  Fargate: ${{ steps.build.outputs.fargate_image_uri }}"
          echo ""
          echo "Deploy workflow will use :latest tag automatically"